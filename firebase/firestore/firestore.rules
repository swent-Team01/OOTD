rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthed() {
      return request.auth != null;
    }

    // Checks whether the viewer is in the friend list of the author.
    function isFriend(viewerUid, authorUid) {
      // Paths
      let viewerPath = /databases/$(database)/documents/accounts/$(viewerUid);
      let authorPath = /databases/$(database)/documents/accounts/$(authorUid);

      return exists(viewerPath) && exists(authorPath)
        && get(authorPath).data.keys().hasAny(['friendUids'])
        && (viewerUid in get(authorPath).data.friendUids);
    }

    // This is used in the following way:
    // When the authenticated user accepts the follow request,
    // they need to add themselves to the friend list of who sent them the request.
    // To do this, there needs to be a notification where the accountOwnerId wants to follow them.
    function hasFollowNotification(accountOwnerId) {
      let notificationId = accountOwnerId + '_follow_' + request.auth.uid;
      return exists(/databases/$(database)/documents/notifications/$(notificationId));
    }

    // Users: read any, write own
    match /users/{userId} {
      allow read: if true;
      allow create: if isAuthed()
        && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthed()
                       && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthed()
           && (resource == null || resource.data.ownerId == request.auth.uid);
    }

    // Notifications: read your own, write your own
    match /notifications/{notificationId} {
      allow read: if isAuthed() && (resource == null ||
        resource.data.receiverId == request.auth.uid ||
        resource.data.senderId == request.auth.uid);

      allow create: if isAuthed() &&
        request.resource.data.senderId == request.auth.uid;

      allow update: if isAuthed() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid);

      allow delete: if isAuthed() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid);
    }

    // Accounts: friends and owner can read,
    // only owner can update, authenticated users can create

    match /accounts/{accountId} {
      allow read: if isAuthed() && (resource == null || resource.data.ownerId == request.auth.uid
                        || isFriend(request.auth.uid, resource.data.ownerId));
      allow create: if isAuthed()
        && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthed()
                       && resource.data.ownerId == request.auth.uid;

      // Non-owner can update ONLY to remove themselves from friendUids
      allow update: if isAuthed()
                     && request.auth.uid != accountId
                     && request.auth.uid in resource.data.friendUids
                     && !(request.auth.uid in request.resource.data.friendUids)
                     && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friendUids']);

      // Non-owner can update ONLY to add themselves to friendUids if there's a follow notification
      allow update: if isAuthed()
                   && request.auth.uid != accountId
                   && !(request.auth.uid in resource.data.friendUids)
                   && request.auth.uid in request.resource.data.friendUids
                   && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friendUids'])
                   && hasFollowNotification(accountId);

      allow delete: if isAuthed()
           && (resource == null || resource.data.ownerId == request.auth.uid);
    }

    // Posts: readable by author or mutual friends OR if public
    match /posts/{postId} {
      allow read: if isAuthed() &&
                              (resource == null || resource.data.ownerId == request.auth.uid ||
                                                 isFriend(request.auth.uid, resource.data.ownerId) ||
                                                 resource.data.isPublic == true);
    allow create: if isAuthed()
        && request.resource.data.ownerId == request.auth.uid;

    // Only owner can update all fields
    allow update: if isAuthed()
           && resource.data.ownerId == request.auth.uid;

    // Allows friends to update ONLY the comments field in their friend's post
    allow update: if isAuthed()
           && request.auth.uid != resource.data.ownerId
           && isFriend(request.auth.uid, resource.data.ownerId)
           && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments']);

    allow delete: if isAuthed()
           && (resource == null || resource.data.ownerId == request.auth.uid);

    }

    match /items/{itemId} {
      allow read: if isAuthed() &&
                        (resource == null || resource.data.ownerId == request.auth.uid ||
                        isFriend(request.auth.uid, resource.data.ownerId) ||
                        resource.data.isPublic == true);

      allow create: if isAuthed()
          && request.resource.data.ownerId == request.auth.uid;

      allow update: if isAuthed()
             && resource.data.ownerId == request.auth.uid;

      allow delete: if isAuthed()
             && (resource == null || resource.data.ownerId == request.auth.uid);
    }

    // Consents: users can only read/write their own consent records
    match /consents/{consentId} {
      allow read: if isAuthed() &&
                     (resource == null || resource.data.userId == request.auth.uid);

      allow create: if isAuthed()
          && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthed()
             && resource.data.userId == request.auth.uid;

      allow delete: if isAuthed()
             && (resource == null || resource.data.userId == request.auth.uid);
    }

    // Likes: Users can like a post if they are the post owner OR a friend of the post owner
    match /likes/{postId}/users/{userId} {

      allow create: if isAuthed()
          && request.auth.uid == userId
          && (
                // Owner can like their own post
                request.auth.uid ==
                  get(/databases/$(database)/documents/posts/$(postId)).data.ownerId
                ||
                // Or a friend of the owner
                isFriend(
                  request.auth.uid,
                  get(/databases/$(database)/documents/posts/$(postId)).data.ownerId
                )
                ||
                // Or if the post is public
                get(/databases/$(database)/documents/posts/$(postId)).data.isPublic == true
             );

      allow delete: if isAuthed()
          && request.auth.uid == userId;

      allow read: if isAuthed()
          && (
                // Owner of the post can see likes
                request.auth.uid ==
                  get(/databases/$(database)/documents/posts/$(postId)).data.ownerId
                ||
                // Or friends of the post owner
                isFriend(
                  request.auth.uid,
                  get(/databases/$(database)/documents/posts/$(postId)).data.ownerId
                )
                ||
                // Or if the post is public
                get(/databases/$(database)/documents/posts/$(postId)).data.isPublic == true
             );
    }



    // Default deny for documents except items
    match /{document=**} {
      allow read, write: if false;
    }
  }
}